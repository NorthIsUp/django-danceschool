{% extends "cms/admin_home.html" %}
{% load sekizai_tags %}

{% block content %}

<h3>{{ series.name }}</h3>

<dl>
	<dt>Total Students:</dt><dd>{{ series.numRegistered }}</dd>
	<dt>Location:</dt><dd>{{ series.location.name }}</dd>
	<dt>Time:</dt><dd>{{ series.startTime|date:'l, h:i A' }}</dd>
	<dt>Drop-Ins Permitted:</dt><dd>{{ series.allowDropins|yesno }}</dd>
</dl>

{% if 'core.checkin_customers' in perms %}
<form id="checkin_form" action="{% url 'formhandler_checkin' %}">
{% endif %}

<table class="classregsummary table" border=1>
<thead>
	<tr>
		{% if 'core.checkin_customers' in perms %}
		<td>Check In</td>
		{% endif %}
		<td>Name</td>
		<td>This Series Price</td>
		<td>Total Payment</td>
		{% if series.allowDropins %}<td>Drop-In</td>{% endif %}
		<td>Student</td>
		<td>Customer Email</td>
		<td>All-Time Classes</td>
		{% if 'core.change_registration' in perms or 'paypal.change_ipnmessage' in perms or 'financial.change_revenueitem' in perms or 'financial.process_registration_refunds' in perms %}
			<td>DB Links</td>
		{% endif %}
	</tr>
</thead>
<tbody>
{% for reg in registrations %}
	<tr>
		{% if 'core.checkin_customers' in perms %}
		<td>
			<input type="checkbox" name="reg_id" value="{{ reg.registration.id }}" {% if reg.checkedIn %}checked{% endif %}/>
		</td>
		{% endif %}
		<td>
			{% if reg.registration.fullName != reg.registration.customer.fullName %}
				<a href="" data-toggle="popover" title="Customer Name" data-container="body" data-placement="top" data-content="Most recent reg. from this email address: {{ reg.registration.customer.fullName }}">{{ reg.registration.fullName }}</a>
			{% else %}
				{{ reg.registration.fullName }}
			{% endif %}
		</td>

		<td {% if reg.revenueMismatch or reg.revenueNotYetReceived != 0 %}class="warning"{% elif reg.revenueRefundsReported != 0 %}class="info"{% endif %}>
			{% if reg.discounted or reg.revenueMismatch or reg.revenueRefundsReported != 0 %}
				<strong>Gross:</strong> {{ reg.price|floatformat:2 }} <br />
				<strong>Net:</strong> {{ reg.netPrice|floatformat:2 }}
				{% if reg.revenueRefundsReported != 0 %}<br />
				<strong>Refunded:</strong> {{ reg.revenueRefundsReported|floatformat:2 }}
				{% endif %}
				{% if reg.revenueMismatch or reg.revenueNotYetReceived %}<br />
				<strong>Recorded Revenue:</strong> {{ reg.revenueReported|floatformat:2 }}<br />
				<strong>Received Revenue:</strong> {{ reg.revenueReceived|floatformat:2 }}<br />
				{% endif %}
			{% else %}
				{{reg.price|floatformat:2 }}
			{% endif %}
		</td>
		
		<td 
		{% if reg.registration.paypalUnallocatedRefunds != 0 or reg.registration.paypalMismatch or reg.registration.revenueNotYetReceived != 0 or reg.registration.revenueMismatch %}
			class="warning"
		{% elif reg.registration.revenueRefundsReported != 0 %}
			class="info"
		{% endif %}>
			{% if reg.registration.totalPrice != reg.registration.amountPaid or reg.registration.paypalUnallocatedRefunds != 0 or reg.registration.paypalMismatch or reg.registration.revenueNotYetReceived != 0 or reg.registration.revenueMismatch or reg.registration.revenueRefundsReported != 0 %}
				<strong>Gross Price:</strong> {{ reg.registration.totalPrice|floatformat:2 }} <br />
				<strong>Net Price:</strong> {% if reg.registration.priceWithDiscount != reg.registration.totalPrice %}
					<a href="" data-toggle="popover" title="Gross vs. Net Price" data-container="body" data-placement="top" data-content="
					{% if reg.registration.discountCode %}Discount Code: {{ reg.registration.discountCode.name }}, {% endif %}
					{% for v in reg.registration.voucheruse_set.all %}
						{% if v.amount > 0 %}
					 		Voucher: {{ v.voucher.voucherId }} = -{{ v.amount }}, 
						{% endif %}
					{% endfor %}">
					{{ reg.registration.priceWithDiscount|floatformat:2 }}</a>
				{% else %}
				 	{{ reg.registration.priceWithDiscount|floatformat:2 }}
				{% endif %}
				{% if reg.registration.paypalReceived != reg.registration.amountPaid or reg.registration.paypalMismatch or reg.registration.paypalUnallocatedRefunds != 0 %}<br />
					<strong>Paypal Rec.:</strong> {{ reg.registration.paypalReceived|floatformat:2 }}
				{% endif %}
				{% if reg.registration.revenueRefundsReported != 0 %}<br />
				<strong>Refunded:</strong> {{ reg.registration.revenueRefundsReported|floatformat:2 }}
				{% endif %}
				{% if reg.registration.revenueMismatch or reg.registration.revenueNotYetReceived %}<br />
				<strong>Recorded Revenue:</strong> {{ reg.registration.revenueReported|floatformat:2 }}<br />
				<strong>Received Revenue:</strong> {{ reg.registration.revenueReceived|floatformat:2 }}<br />
				{% endif %}
			{% else %}
				{{ reg.registration.amountPaid|floatformat:2 }}
			{% endif %}
		</td>
		
		{% if series.allowDropins %}<td>{{ reg.dropIn }}</td>{% endif %}
		<td>{{ reg.registration.customer.isStudent }}</td>
		<td>{{ reg.registration.customer.email }}</td>
		<td>{{ reg.registration.customer.numClassSeries }}</td>
		{% if 'core.change_registration' in perms or 'paypal.change_ipnmessage' in perms or 'financial.change_revenueitem' in perms or 'financial.process_registration_refunds' in perms %}
			<td>
			{% if 'core.change_registration' in perms %}
				<a class="btn btn-default btn-xs" href="{% url 'admin:core_registration_change' reg.registration.id %}">Reg.</a>
			{% endif %}
			{% if 'financial.process_registration_refunds' in perms %}
				<a class="btn btn-default btn-xs" href="{% url 'refundProcessing' reg.registration.id %}">Refund</a>
			{% endif %}
			{% if 'paypal.change_ipnmessage' in perms and reg.registration.ipnmessage %}
				<a class="btn btn-default btn-xs" href="{% url 'admin:paypal_ipnmessage_change' reg.registration.ipnmessage.id %}">IPN</a>
			{% endif %}
			{% if 'financial.change_revenueitem' in perms and reg.revenueitem_set.all %}
				{% for this_item in reg.revenueitem_set.all %}
					<a class="btn btn-default btn-xs" href="{% url 'admin:financial_revenueitem_change' this_item.id %}">Rev. Item</a>
				{% endfor %}
			{% endif %}
			</td>
		{% endif %}
	</tr>
{% endfor %}
</tbody>
</table>

{% if 'core.checkin_customers' in perms %}
	<input type="hidden" name="event_id" value="{{series.id}}" />
	<input type="submit" value="Submit Checkins" />
	</form>

	<div id="update_ok" style="display:none; font-size: 1.5em; color: #0a0; background-color: #ddd; padding: 0.5em; width: 95%;">Check-ins submitted successfully!</div>
	<div id="update_error" style="display:none; font-size: 1.5em; color: #a00; background-color: #ddd; padding: 0.5em; width: 95%;">Error submitting class check-in data.</div>
{% endif %}

<hr />

<p>
<a class="btn btn-default btn-sm" href="{% url 'registration' %}">Class Registration Page</a>
<a class="btn btn-default btn-sm" href="{% url 'viewregistrations_selectevent' %}">Select Another Class</a>
</p>


{% addtoblock "js" %}
	<script type="text/javascript">
	$(function () {
	  $('[data-toggle="popover"]').popover();
	});

	{% if 'core.checkin_customers' in perms %}
	$('input').click(function(){
		$('#update_ok').slideUp();
		$('#update_error').slideUp();
	});

	// Use Jquery to get the cookie value of the CSRF token
	function getCookie(name) {
	    var cookieValue = null;
	    if (document.cookie && document.cookie !== '') {
	        var cookies = document.cookie.split(';');
	        for (var i = 0; i < cookies.length; i++) {
	            var cookie = jQuery.trim(cookies[i]);
	            // Does this cookie string begin with the name we want?
	            if (cookie.substring(0, name.length + 1) === (name + '=')) {
	                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                break;
	            }
	        }
	    }
	    return cookieValue;
	}
	var csrftoken = getCookie('csrftoken');

	function csrfSafeMethod(method) {
	    // these HTTP methods do not require CSRF protection
	    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
	}

	// Ensure that CSRF token is passed
	$.ajaxSetup({
	    beforeSend: function(xhr, settings) {
	        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
	            xhr.setRequestHeader("X-CSRFToken", csrftoken);
	        }
	    }
	});

	$('#checkin_form').submit(function(e) {
		e.preventDefault(); //STOP default action

		var postData = $(this).serializeArray();
		var formURL = $(this).attr("action");

	    $.ajax(
	    {
	        url : formURL,
	        type: "POST",
	        data : postData,
	        success:function(data, textStatus, jqXHR)
	        {
	            $('#update_ok').slideDown();
	        },
	        error: function(jqXHR, textStatus, errorThrown)
	        {
	              $('#update_error').slideDown();
	        }
	    });
	});
	{% endif %}
	</script>
{% endaddtoblock %}

{% endblock %}
