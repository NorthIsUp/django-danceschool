{% load sekizai_tags static i18n %}

{% addtoblock "css" %}
  <link href="{% static 'c3/c3.min.css' %}" rel="stylesheet" type="text/css">
{% endaddtoblock %}


<h3 class="mt-4">{% trans "Performance by Class Type" %}
  <a class="btn btn-sm btn-outline-secondary" href="{% url 'AveragesByClassTypeCSV' %}">{% trans "Download Data" %}</a>
</h3>

<div class="btn-group" role="group" aria-label="...">
  <button type="button" data-startDate="{{ limitMonthDates.12 }}" class="btn btn-outline-secondary active classTypeButton">{% trans "Last 12 Months" %}</button>
  <button type="button" class="btn btn-outline-secondary classTypeButton">{% trans "All Time" %}</button>
</div>

<div id="ClassTypePerformance"></div>


{% addtoblock "js" %}
  <script src="{% static 'd3/d3.min.js' %}"></script>
{% endaddtoblock %}
{% addtoblock "js" %}
  <script src="{% static 'c3/c3.min.js' %}"></script>
{% endaddtoblock %}
{% addtoblock "js" %}
<script type="text/javascript">
$(document).ready(function(){

  var avgAttendanceChart = null;
  var initialShowList = ['Average Registrations']
  var dataKey = 'type'

  function loadClassPerformanceChart(url) {

    $.getJSON(url, function(data) {

        xKeySet = {}
        for(var i in data) for(var k in data[i]) xKeySet[k] = true;

        xkeys = []
        for(var i in xKeySet) if (i != dataKey) xkeys.push(i);

        var hideList = xkeys.slice();

        for (var s in initialShowList) {
           var index = hideList.indexOf(initialShowList[s]);
           if (index > -1) hideList.splice(index, 1);
        }

        var chartData = {
          json: data,
          type: 'bar',
          hide: hideList,
          keys: {
            x: dataKey,
            value: xkeys,
          }
        }

        if(avgAttendanceChart == null) {
          avgAttendanceChart = c3.generate({
            bindto: '#ClassTypePerformance',
            data: chartData,
            axis: {
              x: {
                type: 'category' // this needed to load string x value
              }
            },
          });
        }
        else {
          avgAttendanceChart.load(chartData);
        }

    });
  }

  // Set the initial data on load
  loadClassPerformanceChart("{% url 'AveragesByClassTypeJSON' %}?startDate={{ limitMonthDates.12 }}");

  $('.classTypeButton').click(function(){
      var startDate = $(this).attr('data-startDate');
      loadClassPerformanceChart("{% url 'AveragesByClassTypeJSON' %}?startDate=" + startDate);
      $('.classTypeButton').removeClass('active');
      $(this).addClass('active');
  });

});
</script>
{% endaddtoblock %}
